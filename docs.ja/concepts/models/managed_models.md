# マネージドモデル

ユーザーがテーブル内のデータ管理を担当する通常のテーブルとは異なり、一部のデータベースエンジンでは、エンジン自身がテーブル内のデータを最新に保つ「テーブル」という概念を採用しています。これらのテーブルは通常、データベース内の他のテーブルからデータを読み取るクエリに基づいています。これらの他のテーブルが更新されるたびに、データベースはマネージドテーブルに変更を反映させます。ユーザーが特別な操作（`REFRESH` コマンドの発行など）を行う必要はありません。

サポートされている各データベースエンジンは、内部的には若干異なる方法でこれを実現していますが、ほとんどのエンジンは、テーブル作成時に定義したパラメータの範囲内で、バックグラウンドプロセスを実行し、テーブルを自動的に最新の状態に維持します。

サポートされているエンジンでは、この機能をマネージドモデルを通じて公開しています。これは、基盤となるデータベースエンジンがデータを最新の状態に維持し、SQLMesh が行う必要があるのはスキーマの維持だけであることを示します。

このため、マネージドモデルは通常、別のSQLMeshモデルではなく[外部モデル](./external_models.md)に基づいて構築されます。SQLMeshは既に追跡対象のモデルが最新の状態に保たれていることを保証しているため、マネージドモデルの主なメリットは、SQLMeshによって追跡されていない外部テーブルから読み取る場合に発揮されます。

!!! warning "Pythonモデルではサポートされていません"

    Python モデルは `MANAGED` [モデルの種類](./model_kinds.md) をサポートしていません。代わりに SQL モデルを使用してください。

## マテリアライズド・ビューとの違い

マネージドモデルとマテリアライズド・ビューの違いはセマンティクスによるもので、一部のエンジンでは違いはありません。

SQLMesh は既に [マテリアライズド・ビュー](../model_kinds#materialized-views) をサポートしています。ただし、エンジンによっては、以下のような制限があります。

- マテリアライズド・ビュー・クエリは、単一のベーステーブルからのみ生成できます。
- マテリアライズド・ビューは、エンジンによって自動的にメンテナンスされません。データを更新するには、`REFRESH MATERIALIZED VIEW` または同等のコマンドを発行する必要があります。

マネージドモデルは、以下の点で異なります。

- ベーステーブルが変更されると、エンジンはテーブルデータを自動的に更新します。
- 更新を実行する際、エンジンはクエリの意味を理解し、増分更新と完全更新のどちらを適用するかを判断できます。
- 手動で `REFRESH` コマンドを発行する必要はありません。エンジンは、バックグラウンドプロセスでテーブルを透過的にメンテナンスします。

## SQLMesh のライフサイクル

マネージドモデルは、他のモデルと同じライフサイクルに従います。

- 仮想環境を作成すると、現在のモデルスナップショットへのポインターが作成されます。
- モデルを変更すると、新しいスナップショットが作成されます。
- アップストリームの変更が発生すると、新しいスナップショットが作成されます。
- 通常のポインタスワップメカニズムを使用して、モデルをデプロイおよびロールバックできます。
- TTL が期限切れになると、モデルスナップショットはクリーンアップされます。

ただし、マネージドモデルには通常、ベンダーによって課せられる追加コストがあります。たとえば、Snowflake では、動的テーブルに対して [追加コスト](https://docs.snowflake.com/en/user-guide/dynamic-tables-cost) が発生します。

そのため、マネージドテーブルを不必要に作成しないようにしています。たとえば、[フォワードのみのプラン](../plans.md#forward-only-change) では、変更をプレビューするために通常のテーブルを作成し、本番環境へのデプロイ時にのみマネージドテーブルを再作成します。

!!! warning
    開発プレビューでは通常のテーブルを使用しているため、ターゲットエンジンの通常のテーブルでは利用できるものの、マネージドテーブルでは利用できない機能を使用するクエリを記述してしまう可能性があります。その結果、開発環境ではプランが機能するにもかかわらず、本番環境にデプロイすると失敗するというシナリオが発生する可能性があります。

    コスト削減の効果は十分にあると考えていますが、問題が発生した場合は[お問い合わせ](https://tobikodata.com/slack)ください。

## サポートされているエンジン

SQLMesh は、以下のデータベース エンジンでマネージド モデルをサポートしています。

| エンジン | 実装 |
| ---------------------------------------------------- | -------------------------------------------------------------------------------- |
| [Snowflake](../../integrations/engines/snowflake.md) | [動的テーブル](https://docs.snowflake.com/en/user-guide/dynamic-tables-intro) |

マネージド モデルを定義するには、[`MANAGED`](./model_kinds.md#managed) モデルの種類を使用できます。

### Snowflake

Snowflake のマネージドモデルは、[動的テーブル](https://docs.snowflake.com/en/user-guide/dynamic-tables-intro) として実装されています。

以下は、動的テーブルが作成される SQLMesh モデルの例です。

```sql linenums="1"
MODEL (
  name db.events,
  kind MANAGED,
  physical_properties (
    warehouse = datalake,
    target_lag = '2 minutes',
    data_retention_time_in_days = 2
  )
);

SELECT
  event_date::DATE as event_date,
  event_payload::TEXT as payload
FROM raw_events
```

結果は次のようになります:

```sql linenums="1"
CREATE OR REPLACE DYNAMIC TABLE db.events
  WAREHOUSE = "datalake",
  TARGET_LAG = '2 minutes'
  DATA_RETENTION_TIME_IN_DAYS = 2
AS SELECT
  event_date::DATE as event_date,
  event_payload::TEXT as payload
FROM raw_events
```

!!! note

    SQLMeshは間隔を作成しないため、各間隔ごとにこのモデルを実行します。そのため、通常の増分モデルのように日付フィルターを含むWHERE句を追加する必要はありません。このモデルのデータの更新方法は、Snowflakeに完全に依存します。

#### テーブルプロパティ

動的テーブルには、Snowflake によるデータ更新頻度、初期データの設定タイミング、データの保持期間などに影響するプロパティがいくつかあります。使用可能なプロパティのリストは、[Snowflake のドキュメント](https://docs.snowflake.com/sql-reference/sql/create-dynamic-table) に記載されています。

SQLMesh では、これらのプロパティはモデル定義で設定されます。

以下の動的テーブルプロパティは、モデル [`physical_properties`](../models/overview.md#physical_properties-previously-table_properties) で設定されます。

| Snowflake プロパティ | 必須 | 注記
| ------------------------------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| target_lag | Y | |
| warehouse | N | Snowflake では、これは必須プロパティです。ただし、指定されていない場合、SQLMesh は `select current_warehouse()` の結果を使用します。 |
| refresh_mode | N | |
| initialize | N | |
| data_retention_time_in_days | N | |
| max_data_extension_time_in_days | N | |

以下の動的テーブル プロパティは、モデルに直接設定できます。

| Snowflake プロパティ | 必須 | 注記 |
| ------------------ | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| cluster by | N | `clustered_by` は [標準モデル プロパティ](../models/overview.md#clustered_by) なので、モデルに `clustered_by` を設定して、動的テーブルに `CLUSTER BY` 句を追加します |